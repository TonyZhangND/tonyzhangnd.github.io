<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Mitosis Image Processing Part 2 - Locating Final Points of Interest - Tony Zhang</title>
<meta name="description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Tony Zhang">
<meta property="og:title" content="Mitosis Image Processing Part 2 - Locating Final Points of Interest">
<meta property="og:url" content="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">


  <meta property="og:description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">



  <meta property="og:image" content="https://tonyzhangnd.github.io/assets/images/template-matching/geometry.png">



  <meta name="twitter:site" content="@WhiterMeerkat">
  <meta name="twitter:title" content="Mitosis Image Processing Part 2 - Locating Final Points of Interest">
  <meta name="twitter:description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">
  <meta name="twitter:url" content="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://tonyzhangnd.github.io/assets/images/template-matching/geometry.png">
    
  

  



  <meta property="article:published_time" content="2017-07-28T00:00:00-04:00">





  

  


<link rel="canonical" href="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">





  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://tonyzhangnd.github.io",
      "logo": "https://tonyzhangnd.github.io/assets/images/home-page.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Tony Zhang",
      "url": "https://tonyzhangnd.github.io",
      "sameAs": ["https://www.facebook.com/TonyZhangND","https://twitter.com/WhiterMeerkat","https://www.linkedin.com/in/tonyzhangnd/","https://github.com/TonyZhangND"]
    }
  </script>




  <meta name="msvalidate.01" content="F64491E45F3F27AB0DC01AD1FBFC822E">




<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Tony Zhang Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <!-- Google analytics -->
    <meta name="google-site-verification" content="6jQiHiyZAOn_4uJFMut5IHcWTijv2uESUDVnDQorEuI" />
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Mitosis Image Processing Part 2 - Locating Final Points of Interest - Tony Zhang</title>
<meta name="description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Tony Zhang">
<meta property="og:title" content="Mitosis Image Processing Part 2 - Locating Final Points of Interest">
<meta property="og:url" content="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">


  <meta property="og:description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">



  <meta property="og:image" content="https://tonyzhangnd.github.io/assets/images/template-matching/geometry.png">



  <meta name="twitter:site" content="@WhiterMeerkat">
  <meta name="twitter:title" content="Mitosis Image Processing Part 2 - Locating Final Points of Interest">
  <meta name="twitter:description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">
  <meta name="twitter:url" content="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://tonyzhangnd.github.io/assets/images/template-matching/geometry.png">
    
  

  



  <meta property="article:published_time" content="2017-07-28T00:00:00-04:00">





  

  


<link rel="canonical" href="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html">





  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://tonyzhangnd.github.io",
      "logo": "https://tonyzhangnd.github.io/assets/images/home-page.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Tony Zhang",
      "url": "https://tonyzhangnd.github.io",
      "sameAs": ["https://www.facebook.com/TonyZhangND","https://twitter.com/WhiterMeerkat","https://www.linkedin.com/in/tonyzhangnd/","https://github.com/TonyZhangND"]
    }
  </script>




  <meta name="msvalidate.01" content="F64491E45F3F27AB0DC01AD1FBFC822E">




<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Tony Zhang Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <!-- MathJax for Latex rendering -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">Tony Zhang</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/" >Blog</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/bio_photo.jpg" alt="Tony Zhang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Tony Zhang</h3>
    
    
      <p class="author__bio" itemprop="description">
        CS Ph.D. student <br> Distributed sytems Jedi-in-training <br> UMich @ Ann Arbor
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Ann Arbor, Michigan</span>
        </li>
      

      
        
          
        
          
        
          
            <li><a href="https://twitter.com/WhiterMeerkat" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://www.facebook.com/TonyZhangND" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
          
        
          
            <li><a href="https://github.com/TonyZhangND" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="https://www.instagram.com/whitermeerkat/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
          
        
      

      

      
        <li>
          <a href="mailto:nudzhang@umich.edu">
            <meta itemprop="email" content="nudzhang@umich.edu" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Mitosis Image Processing Part 2 - Locating Final Points of Interest">
    <meta itemprop="description" content="A detailed two-part series about extracting machine-usable data from raw images. Part 2 using data from part 1 and some geometry to locate POIs.">
    <meta itemprop="datePublished" content="July 28, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Mitosis Image Processing Part 2 - Locating Final Points of Interest
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  14 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><img src="/assets/images/template-matching/header-short.png" alt="Before-after image" /></p>
<aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of Contents</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#the-input-data" id="markdown-toc-the-input-data">The Input Data</a></li>
  <li><a href="#geometric-transformation-and-coalescing-algorithm" id="markdown-toc-geometric-transformation-and-coalescing-algorithm">Geometric Transformation and Coalescing Algorithm</a>    <ul>
      <li><a href="#transform" id="markdown-toc-transform">Transform</a></li>
      <li><a href="#coalesce" id="markdown-toc-coalesce">Coalesce</a></li>
    </ul>
  </li>
  <li><a href="#putting-it-all-together" id="markdown-toc-putting-it-all-together">Putting It All Together</a></li>
  <li><a href="#conclusion-and-takeaway" id="markdown-toc-conclusion-and-takeaway">Conclusion and Takeaway</a>    <ul>
      <li><a href="#my-takeaway" id="markdown-toc-my-takeaway">My Takeaway</a></li>
    </ul>
  </li>
  <li><a href="#complete-code" id="markdown-toc-complete-code">Complete Code</a></li>
</ul>

  </nav>
</aside>
<p>The problem we are trying to solve is find the exact locations of cells undergoing mitosis in histology images. These are the cells that are annotated with green arrows. In other words, given the <strong>Before</strong> image above, we want to extract data shown in <strong>After</strong>.</p>

<p>In <a href="https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-1.html">Part 1</a>, I have detailed how I used template matching in openCV to obtain bounding boxes on the arrows with 100% accuracy. In this post, I will describe my algorithm used to transform the bounding box information into the coordinates of the arrowheads.</p>

<h2 id="the-input-data">The Input Data</h2>
<p>We use the code in Part 1, but with one important change:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">misc</span><span class="p">,</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="n">PKL_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">pickle</span> <span class="n">files</span><span class="p">}</span>
<span class="n">LOC_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">final</span> <span class="n">csv</span> <span class="n">files</span><span class="p">}</span>

<span class="p">{</span><span class="kn">import</span> <span class="nn">functions</span> <span class="k">from</span> <span class="n">Part</span> <span class="mi">1</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">match_and_pickle</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="s">""" Apply template matching to img_name in IMG_DIR, using
    tmpl{0...359}.png and mask{0...359}.png.
    
    Output: Coordinates of the top left corner of matching templates, 
    in the format [(deg, [points])], saved in img_name.pkl.
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Matching img </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">MATCH_RES</span><span class="p">):</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MASK_DIR</span><span class="p">,</span> <span class="s">'mask</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmpl</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Failed to match for tmpl </span><span class="si">%</span><span class="s">d.'</span> <span class="o">%</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">img_gray</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_SQDIFF</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">MATCH_THRESH</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1">#top left corners of arrow bounding box
</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">))</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span>
        <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span><span class="p">)</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></div>
<p>Here, I replaced the function <code class="highlighter-rouge">match_and_draw()</code> from Part 1 with <code class="highlighter-rouge">match_and_pickle()</code>. The difference is that instead of drawing the bounding boxes the images, we save the location the arrows and their orientations as pickled data.</p>

<p>Recall that we have 360 arrow templates, one for each degree of orientation, with which we perform template matching. For each image, we save the data in the following Python tuple list format: <br />
<code class="highlighter-rouge">[(deg, [(x, y), ...]), ...]</code>,
where <code class="highlighter-rouge">deg</code> is the orientation of the template that matched, and <code class="highlighter-rouge">(x, y)</code> are the coordinates of the matching bounding box. Note that these are the positions of the top left corners of the bounding boxes.</p>

<p>I can visualize then the bounding boxes with the following code, which loads the pickle data generated by <code class="highlighter-rouge">match_and_pickle()</code> and draws the bounding boxes on a given image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Color_Iterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)]</span>


<span class="n">CI</span> <span class="o">=</span> <span class="n">Color_Iterator</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">draw_from_pkl</span><span class="p">(</span><span class="n">img_name</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s">'./'</span><span class="p">):</span>
    <span class="s">""" Draws bounding boxes on stripped ver of img_name with matches from
    img_name.pkl. 
    Saves output image in output_path.

    Example: draw_from_pkl(M21.jpg, './') draws boxes on M21_s.jpg, and 
    saves output as M21_r.jpg in the current directory.
    """</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_s.jpg'</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">pkl_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span>
        <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span><span class="p">)</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">),</span> <span class="n">CI</span><span class="o">.</span><span class="nb">next</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">img_name</span><span class="o">+</span><span class="s">'_r.jpg'</span><span class="p">),</span> <span class="n">img_rgb</span><span class="p">)</span>  <span class="c1">#eg M21_r.jpg
</span></code></pre></div></div>

<p>The above code produces images that appear like so:</p>

<p><img src="/assets/images/template-matching/res_color box.jpg" alt="Bounding boxes with color" /></p>

<p>Here, I used <code class="highlighter-rouge">Color_Iterator</code> to iterate the color of the boxes drawn. This is to highlight an important feature: <em>There are multiple matches for each arrow</em>. This is because two templates a degree apart may both match on the same arrow; or one template could match many times on the same arrow, each a few pixels apart.</p>

<p>This fact is important later on because it means that there is a many-to-one mapping from matches to arrows. Since we only want one point per arrow in our final output, we need to coalesce a bunch of matches per arrow into one single point.</p>

<h2 id="geometric-transformation-and-coalescing-algorithm">Geometric Transformation and Coalescing Algorithm</h2>

<h3 id="transform">Transform</h3>
<p>One important question is still unanswered. Currently, we only have information regarding the location of the top left corner of the bounding boxes. <strong>As such, how do we transform these points into the position of the arrowheads?</strong> With the orientation of the arrows retrieved from our matching algorithm, this can be done with simple trigonometry!</p>

<p><img src="/assets/images/template-matching/geometry.png" alt="Geometry" /></p>

<p>Consider the above schematic. The dashed box represents the bounding box on the arrow. <script type="math/tex">\alpha</script>, <script type="math/tex">(x, y)</script>, <script type="math/tex">width</script> and <script type="math/tex">height</script> are known quantities, where <script type="math/tex">\alpha</script> is the rotation of the matching template, and <script type="math/tex">width</script>, <script type="math/tex">height</script> are the dimensions of the bounding box.</p>

<p>The center of the bounding box <script type="math/tex">(cx, cy)</script>, which is also the center of the arrow, is:</p>

<script type="math/tex; mode=display">(cx, cy) = (x+\frac{width}{2}, y+\frac{height}{2})</script>

<p>Then, the quantities we are after, <script type="math/tex">(px, py)</script>, are:</p>

<script type="math/tex; mode=display">px = cx - l \cos(\alpha)</script>

<script type="math/tex; mode=display">py = cy + l \sin(\alpha)</script>

<p>where <script type="math/tex">l</script> is the practical pixel radius of the arrow. It is longer than the actual half-length of the arrows because we want <script type="math/tex">(px, py)</script> to be slightly ahead of the arrow tip.</p>

<p>Note that in this case, I have defined the negative x-axis to be zero degrees, and the angle increases anti-clockwise.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">RADIUS</span> <span class="o">=</span> <span class="mi">42</span>

<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
    <span class="s">""" Transforms a list of (deg * coordinate list), where the coordinates
    are of the top-left corner of the tmpl bounding boxes, to a list containting
    the coordinates of the tips of the arrows.
    Returns the list of transformed coordinates.
    """</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>   <span class="c1">#top left corner of arrow bounding box
</span>            <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>  <span class="c1">#center of the arrow
</span>            <span class="n">tips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">RADIUS</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">RADIUS</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">tips</span>
</code></pre></div></div>
<p>In the above code,</p>

<ul>
  <li>The parameter <code class="highlighter-rouge">matches</code> is the list generated by <code class="highlighter-rouge">match_and_picke()</code></li>
  <li><script type="math/tex">\alpha=</script> <code class="highlighter-rouge">deg</code></li>
  <li><script type="math/tex">(x, y)=</script> <code class="highlighter-rouge">pt</code></li>
  <li><script type="math/tex">width=</script> <code class="highlighter-rouge">w</code></li>
  <li><script type="math/tex">height=</script> <code class="highlighter-rouge">h</code></li>
  <li><script type="math/tex">l=</script> <code class="highlighter-rouge">RADIUS</code></li>
  <li><script type="math/tex">[(px, py), ...]=</script> <code class="highlighter-rouge">tips</code></li>
</ul>

<p>Plotting the list of <script type="math/tex">(px, py)</script> on the original image will give us something like this:</p>

<p><img src="/assets/images/template-matching/res_dup arrows.jpg" alt="After transformation" /></p>

<p>Again, if you observe closely, there are multiple points per arrow.</p>

<h3 id="coalesce">Coalesce</h3>
<p>To produce our final output, coalescing multiple points into one final point is straightforward: if two points <script type="math/tex">a</script> and <script type="math/tex">b</script> are within a certain distance, then <script type="math/tex">b</script> is a duplicate.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">coalesce</span><span class="p">(</span><span class="n">tips</span><span class="p">):</span>
    <span class="s">""" Reduces points close to together in tips into one point.
    Returns the list of reduced points.
    """</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="mi">7</span>
    
    <span class="k">def</span> <span class="nf">not_distinct</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
        <span class="p">(</span><span class="n">p1x</span><span class="p">,</span> <span class="n">p1y</span><span class="p">)</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="p">(</span><span class="n">p2x</span><span class="p">,</span> <span class="n">p2y</span><span class="p">)</span> <span class="o">=</span> <span class="n">p2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">p1x</span><span class="o">-</span><span class="n">p2x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1y</span><span class="o">-</span><span class="n">p2y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="o">**</span><span class="mi">2</span> 

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">distinct_pts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dpt</span> <span class="ow">in</span> <span class="n">distinct_pts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">not_distinct</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">dpt</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="n">distinct_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tips</span>
    <span class="n">distinct_pts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
        <span class="n">update</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">distinct_pts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distinct_pts</span>
</code></pre></div></div>

<p>Here, the input <code class="highlighter-rouge">tips</code> is the list of <script type="math/tex">(px, py)</script> for all the arrows in an image. <code class="highlighter-rouge">thresh</code> is the pixel distance between two points for them to be considered duplicates. The return value <code class="highlighter-rouge">distinct_points</code> is then the final set of points in an image, with one point per arrow. This algorithm runs in <script type="math/tex">O(n^2)</script>.</p>

<p>One may imagine that coalescing can be improved to <script type="math/tex">O(n)</script> if we first sort the input list and use the ‘runner technique’. Then we would only need a ‘fast’ pointer to look ahead and find the next distinct point, then add the ‘slow’ pointer to our output and jump the ‘slow’ pointer to the ‘fast’ pointer. But this requires the precondition that no pair of arrows point to <em>similar</em> <script type="math/tex">x</script> <em>or</em> <script type="math/tex">y</script> coordinates, which is something we <em>cannot</em> guarantee.</p>

<h2 id="putting-it-all-together">Putting It All Together</h2>

<p>The following function <code class="highlighter-rouge">transform_and_coalesce()</code> is a wrapper that performs <code class="highlighter-rouge">transform()</code> and <code class="highlighter-rouge">coalesce()</code> on data loaded from a pickle file and then writes the final output into a csv file. The first line is the number of points in the image, followed by one point per line.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">transform_and_coalesce</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="s">""" Applies transform() and coalesce() on data from the pickle file
    of img_name. E.g. M21.pkl from PKL_DIR
    Saves output as a csv file. E.g. M21.csv
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Transforming for image </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">pkl_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span> <span class="n">pkl_name</span><span class="p">),</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to transform img </span><span class="si">%</span><span class="s">s. pkl file not found.'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span>
    <span class="c1">#Write into csv
</span>    <span class="n">csv_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.csv'</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOC_DIR</span><span class="p">,</span> <span class="n">csv_name</span><span class="p">),</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)])</span>  <span class="c1">#1st line is number of arrows
</span>        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></div>

<p>To make sure we get the correct result <code class="highlighter-rouge">plot()</code> draws the points on the image by loading the points from the csv file we created.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">img_name</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s">'plots'</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Plotting image </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">csv_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.csv'</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOC_DIR</span><span class="p">,</span> <span class="n">csv_name</span><span class="p">),</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
                <span class="n">pt_str</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawMarker</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">CI</span><span class="o">.</span><span class="nb">next</span><span class="p">(),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MARKER_CROSS</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">800</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to plot img </span><span class="si">%</span><span class="s">s. pkl file not found.'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">out_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_p.jpg'</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">img_rgb</span><span class="p">)</span>  <span class="c1">#eg M21_p.jpg
</span></code></pre></div></div>

<p>Here is an example of the final result:
<img src="/assets/images/template-matching/res_final.jpg" alt="Final plot" /></p>

<p>We can see that we now only have one point for each arrow, and we are done!</p>

<p>The full code complete with some additional functions for bulk processing are at the end of this page.</p>

<h2 id="conclusion-and-takeaway">Conclusion and Takeaway</h2>
<p>There are some design choices in my program that I would like to address.</p>

<p>First, it is possible, and indeed more efficient, to do away with the pickling and directly pass the output of <code class="highlighter-rouge">match()</code> into <code class="highlighter-rouge">transform_and_coalesce()</code>. However, I chose to have an intermediate pickling stage for the sake of easier debugging. It allows me to draw plots from the pickled data to make sure <code class="highlighter-rouge">match()</code> works as it should. It also allows me to test <code class="highlighter-rouge">transform_and_coalesce()</code> without needing to run <code class="highlighter-rouge">match()</code> over and over again.</p>

<p>Second, my supervisor asked me why I have individual final csv files for each image, instead of saving the data for all my images in one big csv. The answer is that I need the data for machine learning applications later on, but I will probably only need data for a few images at any given time. So separating the csv’s mean less slicing and dicing later on.</p>

<h3 id="my-takeaway">My Takeaway</h3>
<p>Working on this image processing project was something I was really excited about. Through this process, I came to realize what motivates me. I am excited by stuff that I don’t know how to do, stuff that I feel completely clueless about. At times, work goes like this:</p>

<ol>
  <li>Supervisor: Here’s a problem, do you know how to solve it?</li>
  <li>Me: I have absolutely no clue, but that means I will get it done.</li>
  <li>Me a few days later: It is done!</li>
</ol>

<p>On the other hand, I’m less excited about problems where I know there are standard tools and a standard solutions, because then it is grunt work, and there is less to learn from it.</p>

<p>The more clueless I am, the more I want to get my hands on the problem. It is beyond the excitement of learning a new technology or skill. It is the passion of doing something where there is no known recipe, and trying to find out if it can even be done!</p>

<h2 id="complete-code">Complete Code</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">misc</span><span class="p">,</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="n">IMG_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">original</span> <span class="n">images</span><span class="p">}</span>
<span class="n">STRIPPED_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">save</span> <span class="n">stripped</span> <span class="n">images</span><span class="p">}</span>
<span class="n">TMPL_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">templates</span><span class="p">}</span>
<span class="n">MASK_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">masks</span><span class="p">}</span>
<span class="n">PKL_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">pickle</span> <span class="n">files</span><span class="p">}</span>
<span class="n">LOC_DIR</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="n">to</span> <span class="n">final</span> <span class="n">csv</span> <span class="n">files</span><span class="p">}</span>

<span class="n">GREEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">89</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">89</span><span class="p">])</span>
<span class="n">MATCH_THRESH</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">MATCH_RES</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#specifies degree-interval at which to match
#Match thresholds and resolution were empirically tuned
</span><span class="n">RADIUS</span> <span class="o">=</span> <span class="mi">42</span>  <span class="c1">#Half the length of the arrow in pixels
</span>

<span class="k">class</span> <span class="nc">Color_Iterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span><span class="mi">204</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)]</span>


<span class="n">CI</span> <span class="o">=</span> <span class="n">Color_Iterator</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="s">""" Removes background from img_name in IMG_DIR, leaving only green arrows.
    Saves stripped image in STRIPPED_DIR, as img_name's'.jpg 
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Stripping img </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">z_size</span><span class="p">)</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">GREEN</span><span class="p">):</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="o">+</span><span class="s">'_s.jpg'</span><span class="p">),</span> <span class="n">arr</span><span class="p">)</span>  <span class="c1">#eg M21_s.jpg
</span>    <span class="k">return</span>


<span class="k">def</span> <span class="nf">strip_all</span><span class="p">(</span><span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="s">""" Applies strip() to images of name M{start..start+num_images-1}.jpg.

    This method uses multiprocessing:
    num_processes -- the number of parallel processes to spawn for this task.
    (default 2)
    """</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'M[0-9]*.jpg'</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Stripping background from </span><span class="si">%</span><span class="s">d images'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Done'</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">make_templates</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="s">'base_short.png'</span><span class="p">):</span>
    <span class="s">""" Makes templates for rotational-deg=0...359 from base in TMPL_DIR.
    Saves rotated templates as tmpl{deg}.png in TMPL_DIR
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="n">base</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to make templates. Base template is not found'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">360</span><span class="p">):</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> <span class="n">tmpl</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">make_masks</span><span class="p">():</span>
    <span class="s">""" Makes masks from tmpl{0...359}.png in TMPL_DIR.
    Saves masks as mask{0...359}.png in MASK_DIR
    """</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">360</span><span class="p">):</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmpl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Failed to make mask {0}. tmpl{0}.png is not found.'</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">deg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">tmpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> 
                <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="o">+</span><span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_OTSU</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MASK_DIR</span><span class="p">,</span> <span class="s">'mask</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span>



<span class="k">def</span> <span class="nf">match_and_pickle</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="s">""" Apply template matching to img_name in IMG_DIR, using
    tmpl{0...359}.png and mask{0...359}.png.
    
    Output: Coordinates of the top left corner of matching templates, 
    in the format [(deg, [points])], saved in img_name.pkl.
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Matching img </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">MATCH_RES</span><span class="p">):</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MASK_DIR</span><span class="p">,</span> <span class="s">'mask</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmpl</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Failed to match for tmpl </span><span class="si">%</span><span class="s">d.'</span> <span class="o">%</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">img_gray</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_SQDIFF</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">MATCH_THRESH</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">loc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1">#top left corners of arrow bounding box
</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">))</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span>
        <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span><span class="p">)</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">match_all</span><span class="p">(</span><span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="s">""" Applies match() to images of name M{start ... start+num_images-1}s.jpg.

    This method uses multiprocessing:
    num_processes -- the number of parallel processes to spawn for this task.
    (default 2)
    """</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'M[0-9]*_s.jpg'</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Matching </span><span class="si">%</span><span class="s">d images'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">match_and_pickle</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Done'</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">draw_from_pkl</span><span class="p">(</span><span class="n">img_name</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s">'./'</span><span class="p">):</span>
    <span class="s">""" Draws bounding boxes on stripped ver of img_name with matches from
    img_name.pkl. 
    Saves output image in output_path.

    Example: draw_from_pkl(M21.jpg, './') draws boxes on M21_s.jpg, and 
    saves output as M21_r.jpg in the current directory.
    """</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_s.jpg'</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">pkl_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span>
        <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span><span class="p">)</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">),</span> <span class="n">CI</span><span class="o">.</span><span class="nb">next</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">img_name</span><span class="o">+</span><span class="s">'_r.jpg'</span><span class="p">),</span> <span class="n">img_rgb</span><span class="p">)</span>  <span class="c1">#eg M21_r.jpg
</span>

<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
    <span class="s">""" Transforms a list of (deg * coordinate list), where the coordinates
    are of the top-left corner of the tmpl bounding boxes, to a list containting
    the coordinates of the tips of the arrows.
    Returns the list of transformed coordinates.
    """</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TMPL_DIR</span><span class="p">,</span> <span class="s">'tmpl</span><span class="si">%</span><span class="s">d.png'</span> <span class="o">%</span><span class="n">deg</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>   <span class="c1">#top left corner of arrow bounding box
</span>            <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>  <span class="c1">#center of the arrow
</span>            <span class="n">tips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">RADIUS</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">RADIUS</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">tips</span>


<span class="k">def</span> <span class="nf">coalesce</span><span class="p">(</span><span class="n">tips</span><span class="p">):</span>
    <span class="s">""" Reduces points close to together in tips into one point.
    Returns the list of reduced points.
    """</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="mi">7</span>
    
    <span class="k">def</span> <span class="nf">not_distinct</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
        <span class="p">(</span><span class="n">p1x</span><span class="p">,</span> <span class="n">p1y</span><span class="p">)</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="p">(</span><span class="n">p2x</span><span class="p">,</span> <span class="n">p2y</span><span class="p">)</span> <span class="o">=</span> <span class="n">p2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">p1x</span><span class="o">-</span><span class="n">p2x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1y</span><span class="o">-</span><span class="n">p2y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="o">**</span><span class="mi">2</span> 

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">distinct_pts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dpt</span> <span class="ow">in</span> <span class="n">distinct_pts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">not_distinct</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">dpt</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="n">distinct_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tips</span>
    <span class="n">distinct_pts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
        <span class="n">update</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">distinct_pts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distinct_pts</span>


<span class="k">def</span> <span class="nf">transform_and_coalesce</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="s">""" Applies transform() and coalesce() on data from the pickle file
    of img_name. E.g. M21.pkl from PKL_DIR
    Saves output as a csv file. E.g. M21.csv
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Transforming for image </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">pkl_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.pkl'</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKL_DIR</span><span class="p">,</span> <span class="n">pkl_name</span><span class="p">),</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to transform img </span><span class="si">%</span><span class="s">s. pkl file not found.'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span>
    <span class="c1">#Write into csv
</span>    <span class="n">csv_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.csv'</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOC_DIR</span><span class="p">,</span> <span class="n">csv_name</span><span class="p">),</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)])</span>  <span class="c1">#1st line is number of arrows
</span>        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="k">return</span>
        

<span class="k">def</span> <span class="nf">transform_and_coalesce_all</span><span class="p">(</span><span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="s">"""Applies transform_and_coalesce() to images of name 
    M{start ... start+num_images-1}s.jpg.

    This method uses multiprocessing:
    num_processes -- the number of parallel processes to spawn for this task.
    (default 2)
    """</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'M[0-9]*.jpg'</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Transforming </span><span class="si">%</span><span class="s">d images'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">transform_and_coalesce</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Done'</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">img_name</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="s">'plots'</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Plotting image </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="n">csv_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.csv'</span>  <span class="c1">#eg M21.pkl
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOC_DIR</span><span class="p">,</span> <span class="n">csv_name</span><span class="p">),</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
                <span class="n">pt_str</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawMarker</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">CI</span><span class="o">.</span><span class="nb">next</span><span class="p">(),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MARKER_CROSS</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">800</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to plot img </span><span class="si">%</span><span class="s">s. pkl file not found.'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">out_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_p.jpg'</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">img_rgb</span><span class="p">)</span>  <span class="c1">#eg M21_p.jpg
</span>

<span class="k">def</span> <span class="nf">plot_label</span><span class="p">(</span><span class="n">img_name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Plotting image </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
    <span class="n">csv_name</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'.csv'</span>  <span class="c1">#eg M21.pkl
</span>    <span class="n">img_name</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_s.jpg'</span>
    <span class="n">img_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STRIPPED_DIR</span><span class="p">,</span> <span class="n">img_name</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOC_DIR</span><span class="p">,</span> <span class="n">csv_name</span><span class="p">),</span><span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
                <span class="n">pt_str</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">drawMarker</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MARKER_CROSS</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="nb">str</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">70</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">800</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Failed to plot img </span><span class="si">%</span><span class="s">s. pkl file not found.'</span> <span class="o">%</span><span class="n">img_name</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">'_p.jpg'</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">img_rgb</span><span class="p">)</span>  <span class="c1">#eg M21_p.jpg
</span>

<span class="k">def</span> <span class="nf">plot_all</span><span class="p">(</span><span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">IMG_DIR</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'M[0-9]*.jpg'</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Plotting </span><span class="si">%</span><span class="s">d images'</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Done'</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-07-28T00:00:00-04:00">July 28, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=WhiterMeerkat&text=Mitosis+Image+Processing+Part+2+-+Locating+Final+Points+of+Interest%20https%3A%2F%2Ftonyzhangnd.github.io%2F2017%2F07%2FMitosis-Image-Processing-2.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftonyzhangnd.github.io%2F2017%2F07%2FMitosis-Image-Processing-2.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Ftonyzhangnd.github.io%2F2017%2F07%2FMitosis-Image-Processing-2.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2017/07/Mitosis-Image-Processing-1.html" class="pagination--pager" title="Mitosis Image Processing Part 1 - Template Matching Using OpenCV
">Previous</a>
    
    
      <a href="/2017/12/Website-Blocker.html" class="pagination--pager" title="Website Blocker Script - The End of Procrastination
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/travis-jekyll/banner.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2018/06/Integrating-Jekyll-and-Travis-CI.html" rel="permalink">Tutorial - Integrating Jekyll and Travis CI
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">A tutorial on automated build and deployment of Jekyll websites to GitHub Pages using Travis CI.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/consensus/logo.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2018/01/Consensus-TLA-Spec.html" rel="permalink">Consensus Protocol Using TLA+
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Looking to dive into distributed systems research, I recently started learning how to write TLA+ specifications. TLA+ is a specification language used to mat...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/cat_using_com.jpg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2017/12/Website-Blocker.html" rel="permalink">Website Blocker Script - The End of Procrastination
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Like most people, I too am guilty of opening my browser to look up some work related thing on the internet, but somehow find myself half an hour later watchi...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/template-matching/header-tall.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/2017/07/Mitosis-Image-Processing-1.html" rel="permalink">Mitosis Image Processing Part 1 - Template Matching Using OpenCV
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">A detailed two-part series about extracting machine-usable data from raw images. Part 1 focuses on placing bounding boxes on target features.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Tony Zhang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>







  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-139621022-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://tonyzhangnd.github.io/2017/07/Mitosis-Image-Processing-2.html";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/2017/07/Mitosis Image Processing 2"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://tonynudazhang.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
